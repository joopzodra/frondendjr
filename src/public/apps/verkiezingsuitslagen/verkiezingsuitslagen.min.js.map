{"version":3,"sources":["verkiezingsuitslagen.min.js"],"names":["viz","that","d3","formatDefaultLocale","decimal","thousands","grouping","currency","cityDistricts","party","cityParties","totalCityVotes","partiesVotesMax","parties","VVD","fullName","color","PVDA","PVV","SP","D66","CDA","GROENLINKS","CU","PVDD","OVERIGE","BLANCO_ONG","PVDO","HSP","GDM_OP","CU_SGP","ID","PVDE","LEEFBAAR","NIDA","SBU","S_S","cities","amsterdam","center","scale","rotterdam","denhaag","utrecht","select","absOrPerc","selectsContainer","append","attr","on","getData","this","value","property","districtStartText","selectAll","data","entries","enter","d","key","text","selectParty","abs","perc","marginLegend","widthLegend","heightLegend","legendContainer","style","canvasHeight","legendColorBar","window","onresize","renderColorBar","selection","context","node","getContext","image","createImageData","i","j","c","rgb","r","g","b","putImageData","legendSvg","legendAxisX","scaleLinear","domain","range","legendBarWidth","legendAxis","axisBottom","tickSize","tickPadding","ticks","legendAxisContainer","marginCity","widthCity","heightCity","mapSvg","districtTextContainer","tableContainer","tableTitle","table","city","url","json","error","remove","featureCollection","topojson","feature","objects","stad","processCityData","drawCity","writeTable","notPartyFeatureProperties","keys","features","properties","filter","indexOf","push","shift","partiesVotes","partiesPercentages","voters","forEach","totalDistrictVoters","partyVotes","max","projection","geoMercator","path","geoPath","replace","char","toUpperCase","partyRows","partyCellsData","format","exit","tickFormat","call","partyColor","interpolator","interpolateHcl","scaleSequential","noPollingStation"],"mappings":"AAAA,SAASA,MACL,IAAIC,KACJC,GAAGC,qBACCC,QAAS,IACTC,UAAW,IACXC,UAAW,GACXC,UAAW,IAAK,MAGpB,IAyHIC,EACAC,EAEAC,EACAC,EACAC,EA9HAC,GAEAC,KACIC,SAAU,MACVC,MAAO,WAEXC,MACIF,SAAU,OACVC,MAAO,WAEXE,KACIH,SAAU,MACVC,MAAO,WAEXG,IACIJ,SAAU,KACVC,MAAO,WAEXI,KACIL,SAAU,MACVC,MAAO,WAEXK,KACIN,SAAU,MACVC,MAAO,WAEXM,YACIP,SAAU,aACVC,MAAO,WAEXO,IACIR,SAAU,eACVC,MAAO,WAEXQ,MACIT,SAAU,mBACVC,MAAO,WAEXS,SACIV,SAAU,mBACVC,MAAO,WAEXU,YACIX,SAAU,8BACVC,MAAO,QAGXW,MACIZ,SAAU,wBACVC,MAAO,WAGXY,KACIb,SAAU,qBACVC,MAAO,WAEXa,QACId,SAAU,8BACVC,MAAO,WAEXc,QACIf,SAAU,oBACVC,MAAO,WAEXe,IACIhB,SAAU,mBACVC,MAAO,WAEXgB,MACIjB,SAAU,wBACVC,MAAO,WAGXiB,UACIlB,SAAU,qBACVC,MAAO,WAEXkB,MACInB,SAAU,iBACVC,MAAO,WAGXmB,KACIpB,SAAU,sBACVC,MAAO,WAEXoB,KACIrB,SAAU,oBACVC,MAAO,YAGXqB,GACAC,WACIvB,SAAU,YACVwB,QAAS,MAAO,QAChBC,MAAO,MAEXC,WACI1B,SAAU,YACVwB,QAAS,MAAO,OAChBC,MAAO,OAEXE,SACI3B,SAAU,WACVwB,QAAS,MAAO,QAChBC,MAAO,MAEXG,SACI5B,SAAU,UACVwB,QAAS,MAAO,QAChBC,MAAO,OAQXxC,EAAME,GAAG0C,OAAO,QAKhBC,EAAY,MAKZC,EAAmB9C,EAAI+C,OAAO,OAC7BC,KAAK,KAAM,qBACXA,KAAK,QAAS,kBACFF,EAAiBC,OAAO,OACpCC,KAAK,KAAM,eACXD,OAAO,UACPE,GAAG,SAAU,WACdhD,EAAKiD,QAAQC,KAAKC,OAClBlD,GAAG0C,OAAO,2BAA2BS,SAAS,QAASR,GACvDS,MAEOC,UAAU,UAChBC,KAAKtD,GAAGuD,QAAQpB,IAChBqB,QACAX,OAAO,UACPC,KAAK,QAAS,SAAUW,GAAK,OAAOA,EAAEC,MACtCC,KAAK,SAAUF,GAAK,OAAOA,EAAEP,MAAMrC,WACxC,IAAI+C,EAAchB,EAAiBC,OAAO,OACrCC,KAAK,KAAM,gBACXD,OAAO,UACPE,GAAG,SAAU,WACdxC,EAAQ0C,KAAKC,MACbnD,EAAKe,MAAMP,GACX6C,MAEkBR,EAAiBC,OAAO,OACzCC,KAAK,KAAM,mBACXD,OAAO,UACPE,GAAG,SAAU,WACdJ,EAAaM,KAAU,MACvBlD,EAAKe,MAAMP,GACX6C,MAEYC,UAAU,UACrBC,KAAKtD,GAAGuD,SAhDTM,IAAO,SACPC,KAAQ,gBAgDPN,QACAX,OAAO,UACPC,KAAK,QAAS,SAAUW,GAAK,OAAOA,EAAEC,MACtCC,KAAK,SAAUF,GAAK,OAAOA,EAAEP,QAClClD,GAAGqD,UAAU,0BACRP,KAAK,QAAS,YACdO,UAAU,UACVP,KAAK,QAAS,aAEnB,IAAIiB,EACK,EADLA,EAEO,EAFPA,EAGQ,EAHRA,EAIM,GACPC,EAAc,IAAMD,EAAoBA,EAC3CE,EAAe,GAAKF,EAAmBA,EACnCG,EAAkBpE,EAAI+C,OAAO,OAC5BC,KAAK,KAAM,oBACXqB,MAAM,iBAAkB,KAAOF,EAAeF,EAAmBA,IAAwBC,EAAcD,EAAoBA,GAAsB,KAClJK,EAAe,WAAc,OA9DX,GADD,IA+DwDpE,GAAG0C,OAAO,UAAUS,SAAS,eAAiB,MACvHkB,EAAiBH,EAAgBrB,OAAO,UACvCC,KAAK,QAjEW,IAiEeiB,GAC/BjB,KAAK,SAAU,GACfqB,MAAM,SAnEU,IAmEkBJ,GAAqBC,EAAc,IAAO,KAC5EG,MAAM,SAAUC,KACrBE,OAAOC,SAAW,WAAc,OAAOF,EAAeF,MAAM,SAAUC,MACtE,IAAII,EAAiB,SAAUC,EAAW3D,EAAOP,GAG7C,IAAK,IAFDmE,EAAUD,EAAUE,OAAOC,WAAW,MACtCC,EAAQH,EAAQI,gBAxEH,IAwEoCf,EAAmB,GAC/DgB,EAAI,EAAGC,GAAK,EAAGC,OAAI,EAAQF,EAzEnB,MAyEyCA,EACtDE,EAAIjF,GAAGkF,IAAIpE,EAAMiE,EAAIrE,EAAgBH,GAAOoC,GA1E/B,MA2EbkC,EAAMvB,OAAO0B,GAAKC,EAAEE,EACpBN,EAAMvB,OAAO0B,GAAKC,EAAEG,EACpBP,EAAMvB,OAAO0B,GAAKC,EAAEI,EACpBR,EAAMvB,OAAO0B,GAAK,IAEtBN,EAAQY,aAAaT,EAAOd,EAAmB,IAE/CwB,EAAYrB,EAAgBrB,OAAO,OAClCC,KAAK,UAAW,QAAUkB,EAAcD,EAAoBA,GAAsB,KAAOE,EAAeF,EAAmBA,IAC3HlB,OAAO,KACPC,KAAK,YAAa,aAAeiB,EAAoB,KAAOA,EAAmB,KAEhFyB,GADaxF,GAAGyF,cAAcC,QAAQ,EAtFrB,MAsFyCC,OAAO,EAtFhD,MAuFH3F,GAAGyF,cAAcE,OAAO,EAAGC,OACzCC,EAAa7F,GAAG8F,WAAWN,GAAaO,UAvFtB,IAuFiDC,YAAY,GAAGC,MAAM,GACxFC,EAAsBX,EAAU1C,OAAO,KACtCC,KAAK,KAAM,eACXA,KAAK,YAAa,oBAEnBqD,EACK,EADLA,EAEO,GAFPA,EAGQ,EAHRA,EAIM,GACPC,EAAY,IAAMD,EAAkBA,EAAkBE,EAAa,IAAMF,EAAiBA,EAIzFG,EAHexG,EAAI+C,OAAO,OACzBC,KAAK,KAAM,iBACXqB,MAAM,iBAAkB,KAAOkC,EAAaF,EAAiBA,IAAsBC,EAAYD,EAAkBA,GAAoB,KAChHtD,OAAO,OAC5BC,KAAK,UAAW,QAAUsD,EAAYD,EAAkBA,GAAoB,KAAOE,EAAaF,EAAiBA,IACjHtD,OAAO,KACPC,KAAK,YAAa,aAAeqD,EAAkB,KAAOA,EAAiB,KAE5EI,EAAwBzG,EAAI+C,OAAO,OAClCC,KAAK,KAAM,+BACXA,KAAK,QAAS,+BACdD,OAAO,KACRO,EAAoB,WAAc,OAAOmD,EAAsB5C,KAAK,gEACxEP,IAEA,IAAIoD,EAAiB1G,EAAI+C,OAAO,OAC3BC,KAAK,KAAM,mBACXA,KAAK,QAAS,gBACf2D,EAAaD,EAAe3D,OAAO,MACnC6D,EAAQF,EAAe3D,OAAO,SAC7BC,KAAK,QAAS,kCAsKnB,OArKA4D,EAAM7D,OAAO,MACRC,KAAK,QAAS,iBACdO,UAAU,MACVC,MAAM,GAAI,iBAAkB,eAC5BE,QACAX,OAAO,MACPc,KAAK,SAAUF,GAAK,OAAOA,IAGhC1D,EAAKiD,QAAU,SAAU2D,GACrB3G,GAAGqD,UAAU,UAAUF,SAAS,YAAY,GAC5C,IAAIyD,EAAM,QAAUD,EAAO,aAC3B3G,GAAG6G,KAAKD,EAAK,SAAUE,EAAOD,GAC1B,GAAIC,EAKA,MAJA9G,GAAG0C,OAAO,sBAAsBqE,SAChCjH,EAAI+C,OAAO,KACNc,KAAK,mGACLb,KAAK,QAAS,iCACbgE,EAEV,IAAIE,EAAoBC,SAASC,QAAQL,EAAMA,EAAKM,QAAQC,MAC5DrH,EAAKsH,gBAAgBL,GACrBjH,EAAKuH,SAASX,EAAMK,GACpBjH,EAAKwH,WAAWZ,GAChB3G,GAAGqD,UAAU,UAAUF,SAAS,YAAY,MAIpDpD,EAAKsH,gBAAkB,SAAUL,GAE7B,IAAIQ,GAA6B,UAAW,UAAW,UAAW,YAClEhH,EAAcR,GAAGyH,KAAKT,EAAkBU,SAAS,GAAGC,YAC/CC,OAAO,SAAUlE,GAAO,OAAmD,IAA5C8D,EAA0BK,QAAQnE,MAC1DoE,KAAKtH,EAAYuH,SAG7B,IAAIC,KACAC,KA2BJ,OA1BAxH,GAAmByH,OAAQ,GAC3B1H,EAAY2H,QAAQ,SAAU5H,GAC1ByH,EAAazH,MACb0H,EAAmB1H,MACnBE,EAAeF,GAAS,IAE5ByG,EAAkBU,SACbE,OAAO,SAAUV,GAAW,OAA0C,IAAnCA,EAAQS,WAAoB,UAC/DQ,QAAQ,SAAUjB,GACnB,IAAIkB,EAAsBlB,EAAQS,WAAoB,QACtDlH,EAAeyH,QAAUE,EACzB5H,EAAY2H,QAAQ,SAAU5H,GAC1B,IAAI8H,EAAanB,EAAQS,WAAWpH,GACpCyH,EAAazH,GAAOuH,KAAKO,GACzBJ,EAAmB1H,GAAOuH,KAAKO,EAAaD,GAC5C3H,EAAeF,IAAU8H,MAGjC3H,KACAF,EAAY2H,QAAQ,SAAU5H,GAC1BG,EAAgBH,IACZsD,IAAK7D,GAAGsI,IAAIN,EAAazH,IACzBuD,KAAM9D,GAAGsI,IAAIL,EAAmB1H,QAKpCC,YAAaA,EACbC,eAAgBA,EAChBC,gBAAiBA,IAIzBX,EAAKuH,SAAW,SAAUX,EAAMK,GAC5BpD,EAAYP,UAAU,UAAU0D,SAChCnD,EAAYP,UAAU,UACjBC,KAAK9C,GACLgD,QACAX,OAAO,UACPC,KAAK,QAAS,SAAUW,GAAK,OAAOA,IACpCE,KAAK,SAAUF,GAAK,OAAO9C,EAAQ8C,GAAG5C,WAC3C,IAAI0H,EAAavI,GAAGwI,cACfnG,OAAOF,EAAOwE,GAAMtE,QACpBC,MAAMH,EAAOwE,GAAMrE,OACpBmG,EAAOzI,GAAG0I,UAAUH,WAAWA,GACnCvI,GAAG0C,OAAO,mBAAmBqE,SAC7BzG,EAAgBgG,EAAOzD,OAAO,KACzBC,KAAK,KAAM,kBACXO,UAAU,QACVC,KAAK0D,EAAkBU,UACvBlE,QACAX,OAAO,QACPC,KAAK,IAAK2F,GAEflI,EAAQC,EAAY,GACpBT,EAAKe,MAAMP,IAGfR,EAAKwH,WAAa,SAAUZ,GACxBF,EAAW9C,KAAK,8BAAgCgD,EAAKgC,QAAQ,QAAS,SAAUC,GAAQ,OAAOA,EAAKC,iBACpG,IAAIvF,EAAOtD,GAAGuD,QAAQ9C,GACtB6C,EAAKwE,KAAKxE,EAAKyE,SACf,IAAIe,EAAYpC,EAAMrD,UAAU,cAC3BC,KAAKA,GACNyF,EAAiB,SAAUtF,GAC3B,IAAIH,KAIJ,OAHAA,EAAKwE,KAAe,WAAVrE,EAAEC,IAAmB,SAAW/C,EAAQ8C,EAAEC,KAAK7C,UACzDyC,EAAKwE,KAAK9H,GAAGgJ,OAAO,OAAVhJ,CAAkByD,EAAEP,QAC9BI,EAAKwE,KAAK9H,GAAGgJ,OAAO,MAAVhJ,CAAiByD,EAAEP,MAAQzC,EAAeyH,SAC7C5E,GAEXwF,EAAUzF,UAAU,MACfC,KAAKyF,GACLpF,KAAK,SAAUF,GAAK,OAAOA,IACdqF,EAAUtF,QACvBX,OAAO,MACPC,KAAK,QAAS,aACUO,UAAU,MAClCC,KAAKyF,GACLvF,QACAX,OAAO,MACPc,KAAK,SAAUF,GAAK,OAAOA,IAChCqF,EAAUG,OAAOlC,UAGrBhH,EAAKe,MAAQ,SAAUP,GACnBiF,EAAYE,QAAQ,EAAGhF,EAAgBH,GAAOoC,KAC5B,QAAdA,EACAkD,EAAWqD,WAAWlJ,GAAGgJ,OAAO,SAGhCnD,EAAWqD,WAAWlJ,GAAGgJ,OAAO,QAEpC9C,EAAoBiD,KAAKtD,GACzB,IAAIuD,EAAazI,EAAQJ,GAAOO,MAC5BuI,EAAerJ,GAAGsJ,eAAe,UAAWF,GAC5CtI,EAAQd,GAAGuJ,gBAAgBF,GAAc3D,QAAQ,EAAGhF,EAAgBH,GAAOoC,KAC/E0B,EAAe8E,KAAK3E,EAAgB1D,EAAOP,GAC3C,IAAIiJ,EAAmB,SAAU/F,GAAK,OAAO8C,EACxC5C,KAAKF,EAAEkE,WAAoB,QAAI,4CAClB,QAAdhF,EACArC,EACK6D,MAAM,OAAQ,SAAUV,GAAK,OAAgC,IAAzBA,EAAEkE,WAAWpH,GAAgBO,EAAM2C,EAAEkE,WAAWpH,IAAU,SAC9FwC,GAAG,QAAS,SAAUU,IACU,IAA7BA,EAAEkE,WAAoB,QACtB6B,EAAiB/F,GAGjB8C,EACK5C,KAAKhD,EAAQJ,GAAOM,SAAW,KAAO4C,EAAEkE,WAAoB,QAAI,KAAOlE,EAAEkE,WAAWpH,GAAS,eAK1GD,EACK6D,MAAM,OAAQ,SAAUV,GAAK,OAAgC,IAAzBA,EAAEkE,WAAWpH,GAAgBO,EAAM2C,EAAEkE,WAAWpH,GAASkD,EAAEkE,WAAoB,SAAK,SACxH5E,GAAG,QAAS,SAAUU,IACU,IAA7BA,EAAEkE,WAAoB,QACtB6B,EAAiB/F,GAGjB8C,EACK5C,KAAKhD,EAAQJ,GAAOM,SAAW,KAAO4C,EAAEkE,WAAoB,QAAI,MAAQ3H,GAAGgJ,OAAO,MAAVhJ,CAAiByD,EAAEkE,WAAWpH,GAASkD,EAAEkE,WAAoB,SAAK,QAKxJ5H,EAGXD,MAAMkD,QAAQ","file":"verkiezingsuitslagen.min.js","sourcesContent":["function viz() {\n    var that = {};\n    d3.formatDefaultLocale({\n        decimal: ',',\n        thousands: '.',\n        grouping: [3],\n        currency: ['â‚¬', '']\n    });\n    // Mapping some values\n    var parties = {\n        // Landelijk\n        'VVD': {\n            fullName: 'VVD',\n            color: '#455493'\n        },\n        'PVDA': {\n            fullName: 'PvdA',\n            color: '#9A0D1B'\n        },\n        'PVV': {\n            fullName: 'PVV',\n            color: '#1fbbfb'\n        },\n        'SP': {\n            fullName: 'SP',\n            color: '#C73D77'\n        },\n        'D66': {\n            fullName: 'D66',\n            color: '#4AAB2D'\n        },\n        'CDA': {\n            fullName: 'CDA',\n            color: '#00894B'\n        },\n        'GROENLINKS': {\n            fullName: 'GroenLinks',\n            color: '#006B39'\n        },\n        'CU': {\n            fullName: 'ChristenUnie',\n            color: '#032863'\n        },\n        'PVDD': {\n            fullName: 'Partij vd Dieren',\n            color: '#eac134'\n        },\n        'OVERIGE': {\n            fullName: 'Overige partijen',\n            color: '#bebebf'\n        },\n        'BLANCO_ONG': {\n            fullName: 'Blanco en ongeldige stemmen',\n            color: '#ccc'\n        },\n        // Amsterdam\n        'PVDO': {\n            fullName: 'Partij van de Ouderen',\n            color: '#4D9ED6'\n        },\n        // Den Haag            \n        'HSP': {\n            fullName: 'Haagse Stadspartij',\n            color: '#CDC52A'\n        },\n        'GDM_OP': {\n            fullName: 'Groep de Mos, Ouderenpartij',\n            color: '#157F3D'\n        },\n        'CU_SGP': {\n            fullName: 'ChristenUnie, SGP',\n            color: '#032863'\n        },\n        'ID': {\n            fullName: 'Islam Democraten',\n            color: '#7BBD30'\n        },\n        'PVDE': {\n            fullName: 'Partij van de Eenheid',\n            color: '#19803D'\n        },\n        // Rotterdam\n        'LEEFBAAR': {\n            fullName: 'Leefbaar Rotterdam',\n            color: '#359C32'\n        },\n        'NIDA': {\n            fullName: 'Nida Rotterdam',\n            color: '#65AC20'\n        },\n        // Utrecht            \n        'SBU': {\n            fullName: 'Stadsbelang Utrecht',\n            color: '#D70015'\n        },\n        'S_S': {\n            fullName: 'Student & Starter',\n            color: '#31B5CE'\n        }\n    };\n    var cities = {\n        amsterdam: {\n            fullName: 'Amsterdam',\n            center: [4.975, 52.354],\n            scale: 110000\n        },\n        rotterdam: {\n            fullName: 'Rotterdam',\n            center: [4.478, 51.91],\n            scale: 83400\n        },\n        denhaag: {\n            fullName: 'Den Haag',\n            center: [4.364, 52.071],\n            scale: 150000\n        },\n        utrecht: {\n            fullName: 'Utrecht',\n            center: [5.141, 52.081],\n            scale: 140000\n        }\n    };\n    var absOrPercMap = {\n        'abs': 'Aantal',\n        'perc': 'Percentage'\n    };\n    // 'viz-wide' variables\n    var viz = d3.select('#viz');\n    var legendBarWidth = 450; // smaller than the svg size: the legend doesn't need to be as wide as the whole svg (the svg is as wide as the map svg)\n    var legendBarHeight = 25;\n    var cityDistricts;\n    var party;\n    var absOrPerc = 'abs';\n    var cityParties;\n    var totalCityVotes;\n    var partiesVotesMax;\n    // Add the select elements\n    var selectsContainer = viz.append('div')\n        .attr('id', 'selects-container')\n        .attr('class', 'w3-row-padding');\n    var selectCity = selectsContainer.append('div')\n        .attr('id', 'select-city')\n        .append('select')\n        .on('change', function () {\n        that.getData(this.value);\n        d3.select('#select-abs-perc select').property('value', absOrPerc);\n        districtStartText();\n    });\n    selectCity.selectAll('option')\n        .data(d3.entries(cities))\n        .enter()\n        .append('option')\n        .attr('value', function (d) { return d.key; })\n        .text(function (d) { return d.value.fullName; });\n    var selectParty = selectsContainer.append('div')\n        .attr('id', 'select-party')\n        .append('select')\n        .on('change', function () {\n        party = this.value;\n        that.color(party);\n        districtStartText();\n    }); // the options are added in the drawCity functions, because each city has different parties\n    var selectAbsOrPerc = selectsContainer.append('div')\n        .attr('id', 'select-abs-perc')\n        .append('select')\n        .on('change', function () {\n        absOrPerc = (this.value);\n        that.color(party);\n        districtStartText();\n    });\n    selectAbsOrPerc.selectAll('option')\n        .data(d3.entries(absOrPercMap))\n        .enter()\n        .append('option')\n        .attr('value', function (d) { return d.key; })\n        .text(function (d) { return d.value; });\n    d3.selectAll('#selects-container div')\n        .attr('class', 'w3-third')\n        .selectAll('select')\n        .attr('class', 'w3-select');\n    // Add the legend (with canvas colorbar and svg axis)\n    var marginLegend = {\n        top: 0,\n        right: 0,\n        bottom: 0,\n        left: 14\n    }, widthLegend = 670 - marginLegend.left - marginLegend.right, //giving the legend svg the same width as the map svg \n    heightLegend = 50 - marginLegend.top - marginLegend.bottom;\n    var legendContainer = viz.append('div')\n        .attr('id', 'legend-container')\n        .style('padding-bottom', 100 * (heightLegend + marginLegend.top + marginLegend.bottom) / (widthLegend + marginLegend.left + marginLegend.right) + '%');\n    var canvasHeight = function () { return (legendBarHeight / legendBarWidth) * d3.select('canvas').property('clientWidth') + 'px'; }; // function to make canvas height responsive\n    var legendColorBar = legendContainer.append('canvas')\n        .attr('width', legendBarWidth + marginLegend.left)\n        .attr('height', 1) // here is some magic: in renderColorBar we create a canvas with 1 pixels height and so 1 row of pixels; hereafter we change the height by style rule which results repeating the first row, so the whole canvas is colored\n        .style('width', ((legendBarWidth + marginLegend.left) / widthLegend * 100) + '%')\n        .style('height', canvasHeight());\n    window.onresize = function () { return legendColorBar.style('height', canvasHeight()); };\n    var renderColorBar = function (selection, color, party) {\n        var context = selection.node().getContext('2d');\n        var image = context.createImageData(legendBarWidth + marginLegend.left, 1);\n        for (var i = 0, j = -1, c = void 0; i < legendBarWidth; ++i) {\n            c = d3.rgb(color(i * partiesVotesMax[party][absOrPerc] / legendBarWidth));\n            image.data[++j] = c.r;\n            image.data[++j] = c.g;\n            image.data[++j] = c.b;\n            image.data[++j] = 255;\n        }\n        context.putImageData(image, marginLegend.left, 0);\n    };\n    var legendSvg = legendContainer.append('svg')\n        .attr('viewBox', \"0 0 \" + (widthLegend + marginLegend.left + marginLegend.right) + \" \" + (heightLegend + marginLegend.top + marginLegend.bottom))\n        .append('g')\n        .attr('transform', \"translate(\" + marginLegend.left + \", \" + marginLegend.top + \")\");\n    var legendBarX = d3.scaleLinear().domain([0, legendBarWidth]).range([0, legendBarWidth]);\n    var legendAxisX = d3.scaleLinear().range([0, legendBarWidth - 1]); // the domain is added dynamically, depending on city, party and absOrPerc; rangevalue legendBarWidth - 1 is to keep a right outer tick aligned with the bar\n    var legendAxis = d3.axisBottom(legendAxisX).tickSize(-legendBarHeight).tickPadding(8).ticks(6);\n    var legendAxisContainer = legendSvg.append('g')\n        .attr('id', 'legend-axis')\n        .attr('transform', \"translate(0, \" + legendBarHeight + \")\");\n    // Add svg for city map\n    var marginCity = {\n        top: 0,\n        right: 10,\n        bottom: 0,\n        left: 10\n    }, widthCity = 670 - marginCity.left - marginCity.right, heightCity = 500 - marginCity.top - marginCity.bottom;\n    var mapContainer = viz.append('div')\n        .attr('id', 'map-container')\n        .style('padding-bottom', 100 * (heightCity + marginCity.top + marginCity.bottom) / (widthCity + marginCity.left + marginCity.right) + '%');\n    var mapSvg = mapContainer.append('svg')\n        .attr('viewBox', \"0 0 \" + (widthCity + marginCity.left + marginCity.right) + \" \" + (heightCity + marginCity.top + marginCity.bottom))\n        .append('g')\n        .attr('transform', \"translate(\" + marginCity.left + \", \" + marginCity.top + \")\");\n    // Add p element for district name and voting amount\n    var districtTextContainer = viz.append('div')\n        .attr('id', 'district-textinfo-container')\n        .attr('class', 'w3-container w3-pale-yellow')\n        .append('p');\n    var districtStartText = function () { return districtTextContainer.text('Wil je de precieze uitslag van een buurt? Klik op de kaart.'); };\n    districtStartText();\n    // Add table element\n    var tableContainer = viz.append('div')\n        .attr('id', 'table-container')\n        .attr('class', 'w3-container');\n    var tableTitle = tableContainer.append('h5');\n    var table = tableContainer.append('table')\n        .attr('class', 'w3-table w3-border w3-bordered');\n    table.append('tr')\n        .attr('class', 'w3-light-grey')\n        .selectAll('th')\n        .data(['', 'aantal stemmen', 'percentage'])\n        .enter()\n        .append('th')\n        .text(function (d) { return d; });\n    /////////////////////////Get and process data //////////////////////\n    // Get the data and call that.processData and that.drawCity\n    that.getData = function (city) {\n        d3.selectAll('select').property('disabled', true);\n        var url = 'data/' + city + '-topo.json';\n        d3.json(url, function (error, json) {\n            if (error) {\n                d3.select('#map-svg-container').remove();\n                viz.append('p')\n                    .text('Er is een probleem met het laden van de data. Misschien lukt het wel als je de pagina ververst.')\n                    .attr('class', 'w3-container w3-win-metro-red');\n                throw error;\n            }\n            var featureCollection = topojson.feature(json, json.objects.stad);\n            that.processCityData(featureCollection);\n            that.drawCity(city, featureCollection);\n            that.writeTable(city);\n            d3.selectAll('select').property('disabled', false);\n        });\n    };\n    // Process the data to set some 'vize-wide' variables\n    that.processCityData = function (featureCollection) {\n        // Get the parties in this city\n        var notPartyFeatureProperties = ['BU_CODE', 'BU_NAAM', 'KIESGER', 'STEMMEN'];\n        cityParties = d3.keys(featureCollection.features[0].properties)\n            .filter(function (key) { return notPartyFeatureProperties.indexOf(key) === -1; });\n        cityParties.push(cityParties.shift());\n        // Calculate for each party the highest number and the highest percentage of votes over all districts; we need this to set the domain of the legend axis and district fills\n        // To use in the table: calculate to total number of votes in the city for each party and the total number of voters in the city \n        var partiesVotes = {};\n        var partiesPercentages = {};\n        totalCityVotes = { voters: 0 };\n        cityParties.forEach(function (party) {\n            partiesVotes[party] = [];\n            partiesPercentages[party] = [];\n            totalCityVotes[party] = 0;\n        });\n        featureCollection.features\n            .filter(function (feature) { return feature.properties['STEMMEN'] !== -1; }) // -1 means that this district did not have a polling station\n            .forEach(function (feature) {\n            var totalDistrictVoters = feature.properties['STEMMEN'];\n            totalCityVotes.voters += totalDistrictVoters;\n            cityParties.forEach(function (party) {\n                var partyVotes = feature.properties[party];\n                partiesVotes[party].push(partyVotes);\n                partiesPercentages[party].push(partyVotes / totalDistrictVoters);\n                totalCityVotes[party] += partyVotes;\n            });\n        });\n        partiesVotesMax = {};\n        cityParties.forEach(function (party) {\n            partiesVotesMax[party] = {\n                abs: d3.max(partiesVotes[party]),\n                perc: d3.max(partiesPercentages[party])\n            };\n        });\n        //return an object with the processing results which can be used in unit test\n        return {\n            cityParties: cityParties,\n            totalCityVotes: totalCityVotes,\n            partiesVotesMax: partiesVotesMax\n        };\n    };\n    // Draw the city map\n    that.drawCity = function (city, featureCollection) {\n        selectParty.selectAll('option').remove();\n        selectParty.selectAll('option')\n            .data(cityParties)\n            .enter()\n            .append('option')\n            .attr('value', function (d) { return d; })\n            .text(function (d) { return parties[d].fullName; });\n        var projection = d3.geoMercator()\n            .center(cities[city].center)\n            .scale(cities[city].scale);\n        var path = d3.geoPath().projection(projection);\n        d3.select('#city-districts').remove();\n        cityDistricts = mapSvg.append('g')\n            .attr('id', 'city-districts')\n            .selectAll('path')\n            .data(featureCollection.features)\n            .enter()\n            .append('path')\n            .attr('d', path);\n        // initial coloring\n        party = cityParties[0]; // the data is ordered by party size and d3.keys(), with which cityParties is created, maintains this order\n        that.color(party);\n    };\n    // Write the table with the overall city outcomes\n    that.writeTable = function (city) {\n        tableTitle.text(\"Totaal van alle buurten in \" + city.replace(/\\b\\w/g, function (char) { return char.toUpperCase(); }));\n        var data = d3.entries(totalCityVotes);\n        data.push(data.shift()); // voters is first item; move it to the end\n        var partyRows = table.selectAll('.party-row')\n            .data(data);\n        var partyCellsData = function (d) {\n            var data = [];\n            data.push(d.key === 'voters' ? 'Totaal' : parties[d.key].fullName);\n            data.push(d3.format(',.0f')(d.value));\n            data.push(d3.format('.1%')(d.value / totalCityVotes.voters));\n            return data;\n        };\n        partyRows.selectAll('td')\n            .data(partyCellsData)\n            .text(function (d) { return d; });\n        var updatedRows = partyRows.enter()\n            .append('tr')\n            .attr('class', 'party-row');\n        var partyCells = updatedRows.selectAll('td')\n            .data(partyCellsData)\n            .enter()\n            .append('td')\n            .text(function (d) { return d; });\n        partyRows.exit().remove();\n    };\n    // Add the coloring and colorbar axis; we bring the 'viz-wide' variable 'party' in as parameter so we can change it in the unit test\n    that.color = function (party) {\n        legendAxisX.domain([0, partiesVotesMax[party][absOrPerc]]);\n        if (absOrPerc === 'abs') {\n            legendAxis.tickFormat(d3.format(',.0f'));\n        }\n        else {\n            legendAxis.tickFormat(d3.format('.0%'));\n        }\n        legendAxisContainer.call(legendAxis);\n        var partyColor = parties[party].color;\n        var interpolator = d3.interpolateHcl('#fbfdda', partyColor);\n        var color = d3.scaleSequential(interpolator).domain([0, partiesVotesMax[party][absOrPerc]]);\n        legendColorBar.call(renderColorBar, color, party);\n        var noPollingStation = function (d) { return districtTextContainer\n            .text(d.properties['BU_NAAM'] + \": er was in deze buurt geen stembureau.\"); };\n        if (absOrPerc === 'abs') {\n            cityDistricts\n                .style('fill', function (d) { return d.properties[party] !== -1 ? color(d.properties[party]) : '#fff'; }) // -1 means that this district did not have a polling station\n                .on('click', function (d) {\n                if (d.properties['STEMMEN'] === -1) {\n                    noPollingStation(d);\n                }\n                else {\n                    districtTextContainer\n                        .text(parties[party].fullName + \", \" + d.properties['BU_NAAM'] + \": \" + d.properties[party] + \" stemmen.\");\n                }\n            });\n        }\n        else {\n            cityDistricts\n                .style('fill', function (d) { return d.properties[party] !== -1 ? color(d.properties[party] / d.properties['STEMMEN']) : '#fff'; }) // -1 means that this district did not have a polling station\n                .on('click', function (d) {\n                if (d.properties['STEMMEN'] === -1) {\n                    noPollingStation(d);\n                }\n                else {\n                    districtTextContainer\n                        .text(parties[party].fullName + \", \" + d.properties['BU_NAAM'] + \" : \" + d3.format('.1%')(d.properties[party] / d.properties['STEMMEN']) + \".\");\n                }\n            });\n        }\n    };\n    return that;\n}\n// Uncomment these lines when using js scriptfile\nviz().getData('amsterdam'); \n"]}